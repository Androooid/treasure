ç¿»è¯‘æ€»ç»“ä¸€ç¯‡è®²è¿°Androidå•å…ƒæµ‹è¯•çš„æ–‡ç« ï¼Œæ¯”å®˜ç½‘çš„è®²è¿°æ›´å…·æ¡ç†ã€‚åŒæ—¶æè¿°ä¸€äº›åœ¨å®è·µä¸­é‡åˆ°çš„å‘ã€‚
  
__å®˜ç½‘æ–‡æ¡£å…¥å£__  [Best Practices for Testing](http://developer.android.com/intl/zh-cn/training/testing.html)  
__è‹±æ–‡åŸæ–‡åœ°å€__  [Developing Android unit and instrumentation tests](http://www.vogella.com/tutorials/AndroidTesting/article.html)

>ã€å»ºè®®ã€‘è¯»è€…æœ€å¥½å…ˆå¤§è‡´çœ‹ä¸€ä¸‹å®˜ç½‘æ–‡æ¡£ï¼Œç†æ¸…æ¥šç›¸å…³æ¦‚å¿µï¼Œç„¶åå†æ¯”å¯¹è‹±æ–‡åŸæ–‡å’Œæœ¬æ–‡çš„ç¿»è¯‘ï¼Œè¾¹é˜…è¯»è¾¹å®è·µã€‚

##ä¸€ã€ä¸ºä»€ä¹ˆAndroidåº”ç”¨éœ€è¦æµ‹è¯•ï¼Ÿ
###1.1 ä¸ºä»€ä¹ˆæµ‹è¯•Androidåº”ç”¨å°¤å…¶é‡è¦ï¼Ÿ
androidåº”ç”¨åœ¨ä¸€ç§èµ„æºï¼ˆå†…å­˜ï¼ŒCPUï¼Œç”µé‡ç­‰ï¼‰æœ‰é™çš„æƒ…å†µä¸‹è¿è¡Œï¼Œå¹¶ä¸”è¿è¡Œæƒ…å†µä¾èµ–äºå¤–éƒ¨å› ç´ ï¼Œæ¯”å¦‚æ˜¯å¦è”ç½‘ï¼Œä½¿ç”¨æƒ…å†µç­‰ï¼Œå› æ­¤æµ‹è¯•ä¼˜åŒ–androidåº”ç”¨éå¸¸é‡è¦ï¼Œå¯¹åº”ç”¨è¿›è¡Œé€‚å½“çš„æµ‹è¯•æœ‰åŠ©äºæé«˜åº”ç”¨è´¨é‡ï¼Œå¢å¼ºå¯ç»´æŠ¤æ€§ã€‚

###1.2 Androidæµ‹è¯•ç­–ç•¥
åœ¨æ‰€æœ‰ä¸åŒé…ç½®çš„è®¾å¤‡ä¸Šæµ‹è¯•ä¸€ä¸ªåº”ç”¨æ˜¯ä¸å¤§å¯èƒ½çš„ï¼Œä¸€èˆ¬æ¥è¯´åªèƒ½åœ¨å…¸å‹çš„è®¾å¤‡ä¸Šè¿›è¡Œæµ‹è¯•â€”â€”æµ‹è¯•çš„æ—¶å€™åº”è¯¥é€‰å–ä¸€ä¸ªå°½å¯èƒ½ä½é…ç½®çš„è®¾å¤‡å’Œå°½å¯èƒ½é«˜é…ç½®çš„è®¾å¤‡è¿›è¡Œæµ‹è¯•ï¼Œæ‰€è°“é…ç½®ï¼Œæ˜¯è¯¸å¦‚å±å¹•åˆ†è¾¨ç‡ï¼Œåƒç´ å¯†åº¦ç­‰ã€‚

###1.3 Androidçš„æµ‹è¯•æ”¯æŒ
2015å¹´ç”¨äºAndroidåº”ç”¨çš„æµ‹è¯•å·¥å…·å’Œæ¡†æ¶å¾—åˆ°äº†æå¤§çš„æå‡ã€‚Androidçš„æ•´ä¸ªæµ‹è¯•æ”¯æŒç³»ç»Ÿè¢«æ›´æ–°åˆ°åŸºäºJUnit4ï¼Œå•å…ƒæµ‹è¯•ä»£ç æ—¢å¯ä»¥è¿è¡Œåœ¨JVMä¸Šï¼Œä¹Ÿå¯ä»¥è¿è¡Œåœ¨Androidè®¾å¤‡ä¸Šã€‚åŒæ—¶ï¼ŒGoogleå¼•å…¥äº†æ–°çš„UIæµ‹è¯•æ¡†æ¶â€”â€”Espressoï¼Œä½¿å¾—æµ‹è¯•Androidåº”ç”¨çš„UIå˜å¾—æ›´åŠ å®¹æ˜“ã€‚

##äºŒã€å‰ç½®è¦æ±‚
ä¸‹é¢çš„æè¿°åŸºäºå¦‚ä¸‹å‡è®¾ï¼š

1. è¯»è€…å·²ç»çŸ¥é“å¦‚ä½•åˆ›å»ºä¸€ä¸ªAndroidåº”ç”¨ï¼Œè¯»è€…å¯ä»¥é˜…è¯»[Android Tutorial](http://www.vogella.com/tutorials/Android/article.html)è·å–æ›´è¯¦ç»†çš„æ¶ˆæ¯;
2. è¯»è€…äº†è§£Androidçš„ç¼–è¯‘ç³»ç»Ÿâ€”â€”Gradleï¼Œè¯»è€…å¯ä»¥é˜…è¯»[Building Android applications with Gradle Tutorial](http://www.vogella.com/tutorials/AndroidBuild/article.html)è¿›è¡ŒåŸºæœ¬äº†è§£;
3. å¯¹JUnitæµ‹è¯•æ¡†æ¶æœ‰ä¸€å®šçš„äº†è§£ï¼Œè¿™ä¸ªç½‘ä¸Šèµ„æ–™å¾ˆå¤šï¼Œæ¨èä¸€ç¯‡[Javaå•å…ƒæµ‹è¯•(Junit+Mock+ä»£ç è¦†ç›–ç‡)](http://thihy.iteye.com/blog/1771826)

##ä¸‰ã€Androidè‡ªåŠ¨åŒ–æµ‹è¯•
###3.1 æµ‹è¯•ä»€ä¹ˆï¼Ÿ
ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬æµ‹è¯•çš„é‡ç‚¹æ˜¯åº”ç”¨çš„ä¸šåŠ¡é€»è¾‘ï¼Œä»¥ä¸‹çš„æµ‹è¯•æ¯”ä¾‹æ˜¯æ¯”è¾ƒåˆç†çš„ï¼š

1. 70%~80%çš„å•å…ƒæµ‹è¯•ç”¨æ¥ä¿è¯åº•å±‚ä»£ç çš„ç¨³å®šæ€§ï¼›
2. 20%~30%çš„åŠŸèƒ½æµ‹è¯•ç”¨æ¥ä¿è¯åº”ç”¨çš„ç¡®å¯ä»¥æ­£å¸¸è¿è¡Œï¼›
3. å°‘é‡çš„åŠŸèƒ½æµ‹è¯•ç”¨äºæµ‹è¯•ä½ çš„åº”ç”¨å’Œåˆ«çš„åº”ç”¨çš„äº¤äº’â€”â€”å¦‚æœæœ‰çš„è¯ï¼›

###3.2 æµ‹è¯•å‰ç½®æ¡ä»¶
åœ¨Androidæµ‹è¯•ä¸­ä¸ºæ‰€æœ‰çš„æµ‹è¯•å£°æ˜ä¸€ä¸ª __testPreconditions()__ æ–¹æ³•æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„åšæ³•ï¼Œå¦‚æœè¿™ä¸ªæ–¹æ³•æ‰§è¡Œå¤±è´¥äº†ï¼Œä½ å¯ä»¥ç«‹å³çŸ¥é“å…¶ä»–æµ‹è¯•æ‰€ä¾èµ–çš„å‰ç½®æ¡ä»¶ä¸æ»¡è¶³ï¼ˆæ¢è¨€ä¹‹ï¼šé€šè¿‡è¿™ä¸ªæ–¹æ³•ä¿è¯ä¸ºåç»­çš„æµ‹è¯•æä¾›ä¸€ä¸ªç¨³å®šçš„æµ‹è¯•ç¯å¢ƒï¼‰ã€‚

###3.3 æµ‹è¯•å•ä¸ªAppæˆ–è€…å¤šä¸ªApp
æµ‹è¯•å¦å¤–ä¸€ä¸ªé‡è¦è€ƒé‡æ ‡å‡†å°±æ˜¯ä½ æ˜¯å•ç‹¬æµ‹è¯•ä½ è‡ªå·±çš„åº”ç”¨è¿˜æ˜¯æµ‹è¯•ä½ çš„åº”ç”¨å’Œåˆ«çš„åº”ç”¨çš„é›†æˆï¼ˆå³ä¸¤è€…çš„äº¤äº’ï¼‰ã€‚å¦‚æœä½ åªæ˜¯æµ‹è¯•ä½ è‡ªå·±çš„åº”ç”¨ï¼Œé‚£ä¹ˆä½ å¯ä»¥ä½¿ç”¨ä¸€äº›éœ€è¦äº†è§£åº”ç”¨å†…éƒ¨ä¿¡æ¯çš„æµ‹è¯•æ¡†æ¶ï¼ˆæ¯”å¦‚viewIdï¼‰â€”â€”è¿™æ¶‰åŠåˆ°æµ‹è¯•æ¡†æ¶çš„é€‰æ‹©ã€‚

##å››ã€Androidæ™®é€šå•å…ƒå’ŒInstrumentationå•å…ƒæµ‹è¯•
###4.1 Androidå•å…ƒæµ‹è¯•ç§ç±»
Androidå•å…ƒæµ‹è¯•æ˜¯åŸºäºJUnitçš„ï¼Œå¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š

1. æœ¬åœ°å•å…ƒæµ‹è¯•â€”â€”æµ‹è¯•è¿è¡Œåœ¨JVMä¸Šï¼›
2. Instrumentationå•å…ƒæµ‹è¯•â€”â€”æµ‹è¯•éœ€è¦è¿è¡Œåœ¨Androidç³»ç»Ÿä¸Šï¼›

æµ‹è¯•çš„æ—¶å€™åº”è¯¥å°½å¯èƒ½ä½¿ç”¨æœ¬åœ°å•å…ƒæµ‹è¯•ï¼Œå› ä¸ºæœ¬åœ°å•å…ƒæµ‹è¯•ç›¸è¾ƒè€Œè¨€æ›´å¿«ï¼ŒInstrumentationå•å…ƒæµ‹è¯•éœ€è¦éƒ¨ç½²åº”ç”¨å¹¶ä¸”åœ¨Androidè®¾å¤‡ä¸Šè¿è¡Œæµ‹è¯•ã€‚

###4.2 æœ¬åœ°å•å…ƒæµ‹è¯•
Android Gradleæ”¯æŒåœ¨JVMä¸Šè¿è¡ŒAndroidå•å…ƒæµ‹è¯•ï¼Œä¸ºäº†å®ç°è¿™ä¸ªç›®æ ‡ï¼ŒGradleåˆ›å»ºäº†ä¸€ä¸ªç‰¹æ®Šç‰ˆæœ¬çš„android.jarï¼ˆä¹Ÿæˆä¸ºAndroid mockable jarï¼‰æ¥æä¾›å•å…ƒæµ‹è¯•éœ€è¦çš„å„ç§å±æ€§ã€æ–¹æ³•ã€ç±»ã€‚è°ƒç”¨è¿™ä¸ªjaråŒ…ä¸­çš„ä»»ä½•å‡½æ•°éƒ½ä¼šå¯¼è‡´å¼‚å¸¸ã€‚

å› æ­¤ï¼Œå¦‚æœä½ çš„ç±»æ²¡æœ‰è°ƒç”¨ä»»ä½•çš„Android APIæˆ–è€…åªæ˜¯æœ‰å¾ˆç®€å•çš„ä¾èµ–ï¼Œä½ å¯ä»¥æ¯«æ— é™åˆ¶çš„ä½¿ç”¨JUnitæµ‹è¯•æ¡†æ¶ï¼ˆæˆ–è€…åˆ«çš„ä»»ä½•Javaå•å…ƒæµ‹è¯•æ¡†æ¶ï¼‰ã€‚å•å…ƒæµ‹è¯•ä»£ç ä¸­ä»»ä½•å¯¹Androidçš„ä¾èµ–éƒ½åº”è¯¥è¢«æ›¿æ¢æ‰ï¼Œå¯ä»¥ä½¿ç”¨è¯¸å¦‚Mockitoè¿™æ ·çš„Mockæ¡†æ¶ã€‚

åœ¨JVMä¸Šè¿è¡Œæµ‹è¯•caseçš„å¥½å¤„å°±æ˜¯é€Ÿåº¦â€”â€”æ¯”èµ·åœ¨Androidæœºå™¨ä¸Šè¿è¡Œè¦å¿«å¾ˆå¤šå¾ˆå¤šã€‚

###4.3 ä½¿ç”¨Instrumented testæµ‹è¯•ä½¿ç”¨äº†Android APIçš„ç±»
å¦‚æœä½ éœ€è¦æµ‹è¯•ä½¿ç”¨äº†Android APIçš„ä»£ç ï¼Œä½ éœ€è¦åœ¨Androidè®¾å¤‡ä¸Šè¿è¡Œæµ‹è¯•ä»£ç ï¼ˆå› ä¸ºAndroidå·¥å…·ä¸Šmockå‡ºæ¥çš„android.jarå¹¶ä¸æ‰§è¡ŒçœŸæ­£çš„Androidä»£ç ï¼Œè€Œåªæ˜¯ç®€å•çš„æŠ›å‡ºå¼‚å¸¸ï¼‰ï¼Œä¸å¹¸çš„æ˜¯ï¼Œè¿™ä½¿å¾—æµ‹è¯•çš„æ‰§è¡Œæ¼«é•¿äº†è®¸å¤šã€‚

##äº”ã€Androidçš„é¡¹ç›®ç»“æ„å’Œæµ‹è¯•æ–‡ä»¶å¤¹çš„åˆ›å»º
###5.1 Androidçš„æµ‹è¯•é¡¹ç›®ç»“æ„
æ¯”è¾ƒæ¨èçš„æ–¹å¼æ˜¯æŒ‰ç…§çº¦å®šç»„ç»‡sourceä»£ç å’Œæµ‹è¯•ä»£ç ï¼ˆGradleæœ‰è‡ªå·±çš„çº¦å®šï¼‰ï¼Œä½ çš„åº”ç”¨é¡¹ç›®ç»“æ„åº”è¯¥æŒ‰ç…§ä¸‹é¢çš„æ–‡ä»¶å¤¹ç»“æ„è¿›è¡Œç»„ç»‡:

* app/src/main/java - æ”¾ç½®é¡¹ç›®çš„æºç 
* app/src/test/java - æ”¾ç½®è¿è¡Œåœ¨JVMä¸Šçš„å•å…ƒæµ‹è¯•ä»£ç 
* app/src/androidTest/java - æ”¾ç½®éœ€è¦è¿è¡Œåœ¨Androidè®¾å¤‡ä¸Šçš„æµ‹è¯•ä»£ç 

å¦‚æœä½ æŒ‰ç…§è¿™ä¸ªçº¦å®šæ¥ï¼Œé‚£ä¹ˆAndroidçš„ç¼–è¯‘ç³»ç»Ÿï¼ˆGradleï¼‰ä¼šè‡ªåŠ¨å°†å¯¹åº”çš„æµ‹è¯•ä»£ç è¿è¡Œåœ¨JVMå’ŒAndroidè®¾å¤‡ä¸Šã€‚

Gradleä¸Šå¯ä»¥é…ç½®è¿™å‡ ä¸ªæ–‡ä»¶å¤¹ï¼Œè¯»è€…åœ¨ä¸ç†Ÿæ‚‰Gradleçš„æƒ…å†µä¸‹å¹¶ä¸”æ²¡æœ‰ç‰¹æ®Šéœ€æ±‚çš„æƒ…å†µä¸‹ï¼Œä¸å»ºè®®ä¿®æ”¹è¿™ä¸ªçº¦å®šã€‚

##å…­ã€ç¼–å†™æœ¬åœ°å•å…ƒæµ‹è¯•å¹¶ä¸”è¿è¡Œ
å…ˆä¸Šå›¾ï¼Œè®©è¯»è€…æœ‰ä¸ªå¤§è‡´çš„äº†è§£:

![Androidæœ¬åœ°å•å…ƒæµ‹è¯•é¡¹ç›®ç»“æ„](http://7xktd8.com1.z0.glb.clouddn.com/Androidæœ¬åœ°å•å…ƒæµ‹è¯•.png)

###6.1 ç®€ä»‹
åœ¨Androidä¸Šæˆ‘ä»¬ä½¿ç”¨æœ¯è¯­å•å…ƒæµ‹è¯•æ¥è¡¨ç¤ºé‚£äº›è¿è¡Œåœ¨æœ¬åœ°JVMä¸Šçš„æµ‹è¯•ä»£ç ã€‚å•å…ƒæµ‹è¯•åº”å½“è¢«ç”¨æ¥éªŒè¯ä¸€ä¸ªActivityçš„çŠ¶æ€ä»¥åŠå®ƒä¸å…¶ä½™ç»„ä»¶çš„äº¤äº’ï¼Œå‰ææ˜¯åœ¨ç‹¬ç«‹çš„ç¯å¢ƒä¸‹ï¼ˆä¸ç³»ç»Ÿå…¶ä½™éƒ¨åˆ†æ²¡æœ‰è”ç³»ï¼‰ï¼Œå®ƒä¸€èˆ¬ç”¨æ¥æµ‹è¯•ä»£ç çš„ä¸€å°éƒ¨åˆ†ï¼Œæ¯”å¦‚ä¸€ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªç±»æˆ–è€…ä¸€ä¸ªç»„ä»¶ï¼Œä¸”ä¸ä¾èµ–ç³»ç»Ÿæˆ–è€…ç½‘ç»œèµ„æºç­‰å¤–éƒ¨ç¯å¢ƒã€‚ä¸¾ä¸ªæ —å­ï¼Œå‡è®¾åœ¨Activityä¸Šæœ‰ä¸€ä¸ªbuttonæ˜¯ç”¨æ¥å¯åŠ¨å¦å¤–ä¸€ä¸ªActivityçš„ï¼Œå•å…ƒæµ‹è¯•åº”è¯¥è¢«ç”¨æ¥æµ‹è¯•å¯åŠ¨Activityå¯¹åº”çš„intentæ˜¯å¦æ­£ç¡®ï¼Œè€Œä¸æ˜¯é‚£ä¸ªActivityæ˜¯å¦è¢«å¯åŠ¨ã€‚

å¦‚å‰é¢æ‰€è¿°ï¼Œå•å…ƒæµ‹è¯•çš„æ‰§è¡ŒåŸºäºä¸€ä¸ªè¢«ä¿®æ”¹çš„android.jaråŒ…ï¼Œæ‰€æœ‰çš„finalä¿®é¥°ç¬¦éƒ½è¢«ç§»é™¤æ‰äº†ï¼Œè¿™ä½¿å¾—ä½¿ç”¨mockåº“æˆä¸ºç°å®â€”â€”å¦‚æœä½ éœ€è¦ä¾èµ–Androidå¹³å°ï¼Œä½ å°±ä½¿ç”¨mockçš„æ¡†æ¶æ¥ä»£æ›¿é‚£äº›è°ƒç”¨ã€‚

###6.2 ä¾èµ–
å¼€å‘è€…å®˜ç½‘ä¸Šå»ºè®®åœ¨build.gradleä¸­æ·»åŠ å¦‚ä¸‹ä¾èµ–:

```xml
dependencies {
    // Unit testing dependencies
    testCompile 'junit:junit:4.12'
    // Set this dependency if you want to use Mockito
    testCompile 'org.mockito:mockito-core:1.10.19'
    // Set this dependency if you want to use Hamcrest matching
    testCompile 'org.hamcrest:hamcrest-library:1.1'
}
```
æ¯ä¸ªåŒ…çš„ä½œç”¨æ³¨é‡Šä¸­éƒ½å·²ç»æ ‡å‡ºã€‚æ³¨æ„ï¼ï¼ï¼è¿™é‡Œåƒä¸‡ä¸è¦å†™æˆcompileï¼Œç„¶åå»Fileâ€”â€”>Project Structureâ€”â€”>é€‰ä¸­Moduleâ€”â€”>Dependenciesé‡Œé¢ï¼Œå†å°†è¿™ä¸‰ä¸ªåº“çš„Scopeæ”¹ä¸ºTest Compileï¼Œå®è·µä¸­ï¼Œè¿™æ ·æ“ä½œè¿™é‡Œä¼šå˜æˆandroidTestCompileã€‚æ€»ä¹‹ï¼Œè¯·ç¡®ä¿è¿™é‡Œæ˜¯testCompileã€‚

###6.3 ä»£ç ä½ç½®
æˆ‘çš„Android Studioç‰ˆæœ¬æ˜¯1.3.2ï¼Œæ–°å»ºçš„Androidé¡¹ç›®ä¸‹é¢è‡ªå¸¦androidTestç›®å½•ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰testç›®å½•ã€‚æŒ‰ç…§å‰é¢æ‰€è®²è¿°çš„ç›®å½•ç»“æ„çº¦å®šï¼Œæˆ‘ä»¬å°†é¡¹ç›®è§†å›¾åˆ‡æ¢åˆ°Projectä¸‹é¢ï¼Œåœ¨srcç›®å½•ä¸‹é¢æ–°å»ºä¸€ä¸ªtestç›®å½•ã€‚è¯»è€…æ³¨æ„ä¸Šå›¾ä¸­çš„1ï¼Œ2ï¼Œ3ä¸‰ä¸ªéƒ¨åˆ†ï¼Œå¦å¤–è¯»è€…åº”è¯¥ç‚¹å‡»5ï¼Œè°ƒå‡º"Build Variants"è§†å›¾ï¼Œç„¶åå°†Test Artifactè®¾ç½®ä¸ºUnit Testã€‚

###6.4 ä»£ç ç¼–å†™
è¿™é‡Œç»™å‡ºä¸€ä¸ªå®ä¾‹ï¼Œè¯»è€…å¯ä»¥ç›´æ¥Copyæµ‹è¯•ä¸€æŠŠ:

```java
public class FirstTest {
    @Test
    public void test_First(){
        String test = "aa";
        assertEquals(test, "aa");
    }

    @Test
    public void test_Second(){
        String test = "aa";
        assertEquals(test, "aa");
    }

    @Test
    public void test_Third(){
        assertEquals(NumberUtils.calculateSum(100), 100);
    }
}
```
å†™å®Œç±»ä¹‹åï¼Œè¯·æ‰“å¼€Runâ€”â€”>Edit Configurationsè§†å›¾ï¼Œç„¶åç¡®ä¿æ•´ä¸ªè§†å›¾æ˜¯å¦‚ä¸‹æ˜¾ç¤ºçš„:

![Androidå•å…ƒæµ‹è¯•é…ç½®](http://7xktd8.com1.z0.glb.clouddn.com/Androidå•å…ƒæµ‹è¯•é…ç½®.png)

ä¹‹æ‰€ä»¥è¦æ³¨æ„è¿™é‡Œï¼Œæ˜¯å› ä¸ºæˆ‘ç¬¬ä¸€æ¬¡é…ç½®çš„æ—¶å€™ï¼Œä¸çŸ¥é“å› ä¸ºä»€ä¹ˆåŸå› ï¼Œå†™äº†ä¸€ä¸ªå•å…ƒæµ‹è¯•caseï¼Œå´é…ç½®æˆäº†Instrumentæµ‹è¯•caseï¼Œå¯¼è‡´æ¯æ¬¡è¿è¡Œcaseçš„æ—¶å€™éƒ½ä¼šè¦æ±‚å¯åŠ¨Androidè®¾å¤‡ï¼Œç„¶åæŠ¥ä¸‹é¢çš„é”™è¯¯:

```
Running tests
Test running startedTest running failed: 
Instrumentation run failed due to 'java.lang.RuntimeException'
Empty test suite.
```

è¿™ä¸ªé—®é¢˜å›°æ‰°äº†æˆ‘å¾ˆä¹…ã€‚å› æ­¤è¯»è€…ä¸€å®šè¦æ³¨æ„ã€‚

###6.5 è¿è¡Œ
æœ€åæ˜¯è¿è¡Œï¼Œæˆ‘ä»¬åªéœ€è¦å³å‡»ä½ éœ€è¦è¿è¡Œçš„æµ‹è¯•Classï¼Œé€‰æ‹©"Run FirstTest"å³å¯è¿è¡Œï¼Œç„¶ååœ¨å›¾ä¸­7çš„éƒ¨åˆ†å¯ä»¥çœ‹åˆ°æµ‹è¯•æ‰§è¡Œçš„ç»“æœã€‚6åœˆå‡ºçš„æŒ‰é’®å¯ä»¥ç‚¹å‡»ï¼ŒæŸ¥çœ‹æ‰§è¡Œçš„å…¨éƒ¨caseæˆ–è€…æ‰§è¡Œå¤±è´¥çš„caseã€‚

##ä¸ƒã€Instrumentationâ€”â€”Androidåº•å±‚æµ‹è¯•API
###7.1 ç®€ä»‹
Androidæµ‹è¯•APIæä¾›äº†ä¸€äº›æ·±å…¥Androidç»„ä»¶å’Œåº”ç”¨æœ¬èº«å£°æ˜å‘¨æœŸçš„é’©å­å‡½æ•°ã€‚è¿™äº›é’©å­å‡½æ•°ç§°ä¸ºInstrumentation APIâ€”â€”å®ƒä»¬å…è®¸ä½ æ§åˆ¶ç”Ÿå‘½å‘¨æœŸå’Œç”¨æˆ·äº¤äº’äº‹ä»¶ã€‚

åœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼ŒAndroidåº”ç”¨åªèƒ½å¯¹çœŸæ­£çš„ç”Ÿå‘½å‘¨æœŸå’Œç”¨æˆ·äº¤äº’äº‹ä»¶åšå‡ºååº”ï¼Œæ¯”å¦‚ï¼šå¦‚æœAndroidåˆ›å»ºäº†ä¸€ä¸ªActivityï¼Œé‚£ä¹ˆonCreate()æ–¹æ³•å°±ä¼šè¢«è°ƒç”¨ï¼Œæˆ–è€…ç”¨æˆ·ç‚¹å‡»äº†ä¸€ä¸ªæŒ‰é’®ï¼Œä¸€ä¸ªæŒ‰é”®ï¼Œé‚£ä¹ˆç›¸åº”çš„ç›‘å¬æ–¹æ³•å°±ä¼šè¢«è°ƒç”¨ã€‚ä½†æ˜¯é€šè¿‡Instrumentationï¼Œä½ å¯ä»¥åœ¨æµ‹è¯•ä»£ç ä¸­æ§åˆ¶è¿™äº›äº‹ä»¶ã€‚

åªæœ‰åŸºäºInstrumentationçš„æµ‹è¯•ä»£ç æ‰èƒ½åœ¨æµ‹è¯•ç¯å¢ƒä¸‹å‘ä½ çš„åº”ç”¨å‘é€äº‹ä»¶ã€‚ä¸¾ä¸ªæ —å­ï¼šä½ å¯ä»¥åœ¨æµ‹è¯•ä¸­è°ƒç”¨getActivity()æ–¹æ³•æ¥å”¤èµ·ä¸€ä¸ªActivityå¹¶è·å¾—ä¸€ä¸ªActivityçš„å®ä¾‹ï¼Œç„¶åä½ å¯ä»¥è°ƒç”¨finish()æ–¹æ³•ç»“æŸå®ƒï¼Œç„¶åå†è°ƒç”¨getActivity()ï¼Œè¿™æ ·ä½ å°±å¯ä»¥æµ‹è¯•ä¸€ä¸ªActivityèƒ½å¦æ­£ç¡®æ¢å¤çŠ¶æ€ã€‚

###7.2 Androidç³»ç»Ÿå¦‚ä½•æ‰§è¡Œæµ‹è¯•
InstrumentationTestRunneræ˜¯Androidå•å…ƒæµ‹è¯•çš„åŸºç¡€æ‰§è¡Œå™¨ï¼ˆRunnerï¼Œè¿™ä¸ªæ¦‚å¿µæ¥è‡ªJUnitï¼Œå‰é¢æ¨èçš„æ–‡ç« ä¸­æœ‰æåŠï¼‰ï¼Œè¿™ä¸ªæµ‹è¯•æ‰§è¡Œå™¨ä¼šåŠ è½½æ‰€æœ‰çš„æµ‹è¯•æ–¹æ³•ï¼Œé€šè¿‡Instrumentation APIæ¥å’ŒAndroidç³»ç»Ÿäº¤äº’ã€‚

å¦‚æœä½ ä¸ºAndroidåº”ç”¨å¯åŠ¨äº†ä¸€ä¸ªæµ‹è¯•ï¼ŒAndroidç³»ç»Ÿä¼šç«‹åˆ»ç»ˆæ­¢è¢«æµ‹è¯•åº”ç”¨çš„è¿›ç¨‹ï¼Œç„¶åå¯åŠ¨ä¸€ä¸ªæ–°çš„å®ä¾‹ã€‚å®ƒä¸ä¼šå¯åŠ¨åº”ç”¨ï¼Œè¿™æ˜¯æµ‹è¯•æ–¹æ³•çš„èŒè´£â€”â€”æµ‹è¯•æ–¹æ³•æ§åˆ¶åº”ç”¨ç»„ä»¶çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸã€‚

æµ‹è¯•æ‰§è¡Œå™¨åœ¨åˆå§‹åŒ–ç•Œé¢çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿä¼šè°ƒç”¨Applicationå’ŒActivityçš„onCreate()æ–¹æ³•ã€‚ï¼ˆå¯ä»¥è®¤ä¸ºInstrumentation APIæä¾›äº†ä¸€ä¸ªåŠŸèƒ½è®©æµ‹è¯•ä»£ç æ‰®æ¼”ç³»ç»Ÿçš„è§’è‰²ï¼‰ã€‚

###7.3 Instrumentationæ¡†æ¶çš„ä½¿ç”¨
æœ‰äº†è¿è¡Œåœ¨JVMä¸Šçš„Androidå•å…ƒæµ‹è¯•å’Œç±»ä¼¼Espressoè¿™æ ·æµè¡Œçš„UIæµ‹è¯•æ¡†æ¶ï¼Œå¼€å‘è€…å¾ˆå°‘éœ€è¦ç›´æ¥è°ƒç”¨Instrumentation APIã€‚

##å…«ã€Instrumented unit testing
###8.1 åœ¨Androidä¸Šä½¿ç”¨Instrumented unit testing
Instrumented unit testingæ˜¯è¿è¡Œåœ¨AndroidçœŸå®è®¾å¤‡æˆ–è€…æ¨¡æ‹Ÿå™¨ä¸Šçš„æµ‹è¯•ä»£ç ï¼Œè€Œä¸æ˜¯JVMä¸Šã€‚è¿™äº›æµ‹è¯•ä»£ç å¯ä»¥è·å–çœŸå®è®¾å¤‡çš„èµ„æºï¼Œä»¥ä¾¿äºæµ‹è¯•é‚£äº›ä¸èƒ½è¢«mockæ¡†æ¶ç®€å•mockå‡ºæ¥çš„åŠŸèƒ½æ¨¡å—ã€‚

[Mockitoæ¡†æ¶](https://github.com/mockito/mockito)å¯ä»¥è¢«ç”¨æ¥æ¨¡æ‹Ÿéƒ¨åˆ†çš„Androidç³»ç»Ÿç¯å¢ƒï¼ˆè¯»è€…å¯ä»¥æŸ¥çœ‹å®ƒçš„release noteï¼Œ1.9.5ç‰ˆæœ¬å³æ”¯æŒè¿™ä¸ªåŠŸèƒ½ï¼‰ï¼Œè¿™ä¹Ÿæ˜¯googleå®˜æ–¹æ¨èçš„mockå·¥å…·ã€‚

###8.2 Instrumentationæµ‹è¯•ä»£ç çš„ä½ç½®
å¦‚å‰é¢æ‰€è¿°ï¼ŒInstrumentationæµ‹è¯•ä»£ç åº”è¯¥æ”¾ç½®åœ¨app/src/androidTest/javaç›®å½•ä¸‹é¢ã€‚

###8.3 åœ¨Gradleä¸­é…ç½®ä¾èµ–
å’Œæœ¬åœ°å•å…ƒæµ‹è¯•ä¸€æ ·ï¼Œä½¿ç”¨Instrumentationæµ‹è¯•ä¹Ÿå¿…é¡»æ·»åŠ ä¸€äº›ä¾èµ–ï¼ŒåŒæ—¶è¿˜å¿…é¡»æ·»åŠ é»˜è®¤çš„Android Instrumentationæµ‹è¯•æ‰§è¡Œå™¨é…ç½®:

```java
defaultConfig {
       ..... more stuff
        testInstrumentationRunner "android.support.test.runner.AndroidJUnitRunner"
    }

dependencies {
    // Unit testing dependencies
    androidTestCompile 'junit:junit:4.12'
    // Set this dependency if you want to use the Hamcrest matcher library
    androidTestCompile 'org.hamcrest:hamcrest-library:1.3'
    // more stuff, e.g., Mockito
} 
```

###8.4 ç›¸å…³çš„ç±»
å…ˆæ¥çœ‹Contextæµ‹è¯•ç±»çš„é‡è¦åŸºç¡€ç±»â€”â€”AndroidTestCaseã€‚è¿™ä¸ªç±»æœ€ç»ˆçš„åŠŸèƒ½å°±æ˜¯æä¾›äº†getContext()åŠŸèƒ½ï¼Œåœ¨å®é™…æµ‹è¯•ä¸­ï¼Œå®ƒçš„è¿”å›å€¼æ˜¯å¯ä»¥å½“åšæµ‹è¯•Appå¯¹è±¡çš„Contextä½¿ç”¨çš„ã€‚è¿™ä¸ªç±»çš„å­ç±»å¦‚ä¸‹:

1. ApplicationTestCase;
2. ProviderTestCase;
3. ServiceTestCase
4. CustomTabsIntentCase;
5. LoaderTestCase;

å¾ˆå®¹æ˜“å‘ç°ï¼Œå››å¤§ç»„ä»¶æœ‰ä¸¤ä¸ªç»„ä»¶åœ¨è¿™é‡Œæœ‰å¯¹åº”çš„æµ‹è¯•Caseç±»ï¼Œé‚£ä¹ˆæœ€é‡è¦çš„Activityå‘¢ï¼Ÿå®é™…ä¸Šç¡®å®æœ‰ActivityTestCaseç±»ï¼Œä½†è¿™ä¸ªç±»ä¸å±äºAndroidTestCaseç»§æ‰¿æ ‘ï¼Œå®ƒçš„çˆ¶ç±»æ˜¯InstrumentationTestCaseï¼Œç›´æ¥å­ç±»æ˜¯:

1. ActivityInstrumentationTestCase
2. ActivityInstrumentationTestCase2
3. ActivityUnitTestCase

å…¶ä¸­ç¬¬ä¸€ä¸ªç±»å·²ç»è¢«åºŸå¼ƒï¼Œç°åœ¨ä½¿ç”¨çš„éƒ½æ˜¯ActivityInstrumentationTestCase2è¿™ä¸ªç±»ã€‚åé¢ä¸¤ä¸ªç±»å°±æ˜¯[å®˜ç½‘æ•™ç¨‹](http://developer.android.com/intl/zh-cn/training/activity-testing/preparing-activity-testing.html)çš„è®²è¿°é‡ç‚¹ã€‚

ä»¥ä¸Šæ‰€æœ‰çš„ç±»éƒ½æ˜¯junit.framework.TestCaseçš„å­ç±»ï¼Œç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š

![Androidå•å…ƒæµ‹è¯•é…ç½®](http://7xktd8.com1.z0.glb.clouddn.com/å•æµ‹ç±»ç»§æ‰¿å…³ç³».png)

####8.4.1 ActivityUnitTestCaseå’ŒActivityInstrumentationTestCase2çš„åŒºåˆ«
ä¸¤è€…éƒ½èƒ½è¿›è¡Œç®€å•çš„UIæµ‹è¯•ï¼Œæ¯”å¦‚UIå…ƒç´ çš„å¸ƒå±€ã€æ˜¾ç¤ºå†…å®¹å’Œç‚¹å‡»åŠ¨ä½œï¼Œæ¯”å¦‚ï¼š

```java
@MediumTest
public void testClickMeButton_clickButtonAndExpectInfoText() {
    String expectedInfoText = mClickFunActivity.getString(R.string.info_text);
    TouchUtils.clickView(this, mClickMeButton);
    assertTrue(View.VISIBLE == mInfoTextView.getVisibility());
    assertEquals(expectedInfoText, mInfoTextView.getText());
}
```

ä½†æ˜¯ä¸¤è€…çš„ä¾§é‡ç‚¹ä¸ä¸€æ ·ã€‚

ActivityUnitTestCaseåˆ›å»ºçš„Activityä¼šå°½é‡å°‘çš„å’Œç³»ç»Ÿæœ‰è”ç³»ï¼Œæ‰€æœ‰çš„ä¾èµ–éƒ½å¯ä»¥é€šè¿‡Mockæˆ–è€…åˆ«çš„æ–¹å¼æ³¨å…¥è¿›å»ï¼Œä½ çš„æµ‹è¯•å¯¹è±¡Activityä¼šåœ¨çœŸå®çš„ç³»ç»Ÿä¸Šè¿è¡Œï¼Œå¹¶ä¸”ä¸ä¼šå’Œåˆ«çš„Activityäº§ç”Ÿäº¤äº’ã€‚ä»¥ä¸‹æ–¹æ³•éƒ½ä¸åº”è¯¥è¢«è°ƒç”¨ï¼Œå¤§éƒ¨åˆ†éƒ½ä¼šæŠ›å‡ºå¼‚å¸¸:

1. createPendingResult(int, Intent, int)
2. startActivityIfNeeded(Intent, int)
3. startActivityFromChild(Activity, Intent, int)
4. startNextMatchingActivity(Intent)
5. getCallingActivity()
6. getCallingPackage()
7. createPendingResult(int, Intent, int)
8. getTaskId()
9. isTaskRoot()
10. moveTaskToBack(boolean)

è¿™äº›æ–¹æ³•éƒ½æ˜¯å’Œç¯å¢ƒè¿›è¡Œäº¤äº’çš„ï¼Œéœ€è¦å®Œæ•´çš„ä¸Šä¸‹æ–‡ã€‚è€Œ

1. startActivity
2. startActivityForResult

è¿™ä¸¤ä¸ªè°ƒç”¨æ˜¯æ²¡æœ‰æ•ˆæœçš„ï¼Œå¯ä»¥ä½¿ç”¨getStartedActivityIntent()å’ŒgetStartedActivityRequest()æ¥è·å–è°ƒç”¨å‚æ•°ã€‚

1. finish
2. finishActivity
3. finishFromChild

è¿™äº›è°ƒç”¨ä¹Ÿä¸ä¼šæœ‰ä»»ä½•çš„æ•ˆæœï¼ŒåŒæ ·æœ‰æ–¹æ³•isFinishCalled()å’ŒgetFinishedActivityRequest()æ¥è·å–è°ƒç”¨å‚æ•°ã€‚

é€šè¿‡ä»¥ä¸Šæ–¹å¼ï¼Œä¸€ä¸ªActivityUnitTestCaseå¯ä»¥æµ‹è¯•ä¸€äº›å’Œå…¶ä½™ç»„ä»¶çš„â€œMockäº¤äº’â€ã€‚

ä½†å¦‚æœä½ éœ€è¦è¿›è¡ŒåŠŸèƒ½æµ‹è¯•ï¼Œåˆ™å»ºè®®ä½¿ç”¨ActivityInstrumentationTestCase2ã€‚ActivityInstrumentationTestCase2ä¹Ÿæ˜¯å»ºç«‹åœ¨çœŸå®çš„ç³»ç»ŸåŸºç¡€ä¸Šçš„ï¼Œè°ƒç”¨çš„æ˜¯InstrumentationTestCase.launchActivity()æ–¹æ³•ï¼Œä½ å¯ä»¥ç›´æ¥æ“çºµActivityã€‚å•å…ƒæµ‹è¯•ä¸€èˆ¬ä¸å¤ªé€‚åˆç”¨æ¥æµ‹è¯•å¤æ‚çš„UIäº¤äº’åŠ¨ä½œï¼Œè€ŒActivityInstrumentationTestCase2åˆ™éå¸¸é€‚åˆï¼Œæ¯”å¦‚è°ƒç”¨é”®ç›˜å‘EditTextä¸­è¾“å…¥æ–‡å­—ï¼ŒçœŸå®çš„å‘èµ·ä¸€ä¸ªActivityå¹¶æ£€æµ‹æ•°æ®çš„ä¼ è¾“ã€‚å…·ä½“å¯ä»¥è§å®˜æ–¹æ¡ˆä¾‹ï¼š[Creating Functional Tests](http://developer.android.com/intl/zh-cn/training/activity-testing/activity-functional-testing.html)ã€‚å¤§åé¼é¼çš„robotiumå°±æ˜¯åŸºäºè¿™ä¸ªç±»æ¥å®ç°çš„ã€‚

####8.4.2 å·¥å…·ç±»
1. MoreAssertsç±»åŒ…å«æ›´å¤šå¼ºå¤§çš„æ–­è¨€æ–¹æ³•ï¼Œå¦‚assertContainsRegex(String, String)ï¼Œå¯ä»¥ä½œæ­£åˆ™è¡¨è¾¾å¼çš„åŒ¹é…ã€‚
2. ViewAssertsç±»åŒ…å«å…³äºAndroid Viewçš„æœ‰ç”¨æ–­è¨€æ–¹æ³•ï¼Œå¦‚assertHasScreenCoordinates(View, View, int, int)ï¼Œå¯ä»¥æµ‹è¯•Viewåœ¨å¯è§†åŒºåŸŸçš„ç‰¹å®šXã€Yä½ç½®ã€‚è¿™äº›Assertç®€åŒ–äº†UIä¸­å‡ ä½•å›¾å½¢å’Œå¯¹é½æ–¹å¼çš„æµ‹è¯•ã€‚

###8.5 è¿è¡ŒInstrumentationæµ‹è¯•
æ‰§è¡Œå‘½ä»¤ __gradlew build connectedCheck__  å°±å¯ä»¥äº†ã€‚

é™¤äº†å‘½ä»¤è¡Œçš„æ–¹å¼ï¼Œè¿˜æœ‰ä¸€ç§å°±æ˜¯ç›´æ¥ä»Android Studioæ‰§è¡Œã€‚å›åˆ°æœ€ä¸Šé¢é‚£å¼ å›¾ï¼Œåœ¨4éƒ¨åˆ†ï¼Œå³Test Artifacté‡Œé¢ï¼Œè¿˜æœ‰ä¸€ä¸ªé€‰æ‹©æ˜¯"Android Instrumentation Tests"ï¼Œåˆ‡æ¢åˆ°è¿™ä¸ªæ¨¡å¼ï¼Œç„¶åé€‰ä¸­éœ€è¦æ‰§è¡Œçš„ç±»ï¼Œé€‰æ‹©Runå³å¯ã€‚

##ä¹ã€æ€»ç»“
è¿™ç¯‡æ–‡ç« ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†è®©è¯»è€…åˆæ­¥äº†è§£Androidå•å…ƒæµ‹è¯•çš„åˆ†ç±»ä»¥åŠåŸºæœ¬çš„æµ‹è¯•çŸ¥è¯†ã€‚

ä»å®é™…ä½¿ç”¨æ•ˆæœæ¥çœ‹ï¼Œæœ¬åœ°æ™®é€šå•å…ƒæµ‹è¯•å’ŒInstrumentationå•å…ƒæµ‹è¯•äº’ç›¸è¡¥è¶³ï¼ŒåŸºæœ¬æ»¡è¶³äº†ä¸å››å¤§ç»„ä»¶æ— å…³çš„æµ‹è¯•ï¼Œä½†æ˜¯ä»ç„¶æœ‰å¾ˆå¤šçš„æƒ…å†µä¸èƒ½Cover:

1. æœ¬åœ°æ™®é€šå•å…ƒæµ‹è¯•åªèƒ½Coverä¸å¹³å°æ— å…³çš„ä»£ç ï¼›
2. Instrumentationæµ‹è¯•è™½ç„¶æä¾›äº†Contextï¼Œä½†æ˜¯æµ‹è¯•ç»“æœå¾ˆå¤šä¾èµ–äºå®é™…çš„è¿è¡Œç¯å¢ƒï¼Œå¹¶ä¸”æ‰§è¡Œç»“æœæ˜¯åæ˜ åœ¨UIä¸Šçš„ï¼Œå› æ­¤æ•ˆæœæœ‰é™ï¼›

ä¸¾å‡ ä¸ªğŸŒ°:

```java
//ä¸å®é™…ç¼–è¯‘ç¯å¢ƒç›¸å…³
public static int getSdkVersion() {
	try {
		return Build.VERSION.class.getField("SDK_INT").getInt(null);
	} catch (Exception e) {
		return 3;
	}
}

//ä¸Appæœ¬èº«ç›¸å…³
public static String getAppName(Context context) {
	return getAppName(context, null);
}

//ä¸è®¾å¤‡ç›¸å…³
public static boolean hasFeature(Context context, String feature) {
	return context.getPackageManager().hasSystemFeature(feature);
}

//ç»“æœåæ˜ åœ¨UIä¸Š
public static void hideSoftKeyboard(@NonNull View view) {
	InputMethodManager imm = (InputMethodManager) view.getContext().getSystemService(Context.INPUT_METHOD_SERVICE);
	imm.hideSoftInputFromWindow(view.getWindowToken(), 0);
}
```
ä»¥ä¸Šè¿™äº›ä¾‹å­åœ¨å®¢æˆ·ç«¯å¾ˆéš¾å®ŒæˆUTï¼Œå› æ­¤å®ƒä»¬æ˜¯ä¸åº”è¯¥ä½¿ç”¨UTçš„ï¼Œå¿…è¦æ€§ä¹Ÿä¸æ˜¯å¾ˆå¤§ã€‚

ç»¼ä¸Šï¼ŒUTåœ¨å®¢æˆ·ç«¯çš„ä½¿ç”¨èŒƒå›´å’Œæ•ˆæœæ˜¯å¾ˆæœ‰é™çš„ã€‚å®¢æˆ·ç«¯å¼€å‘äººå‘˜åº”å½“ç†ŸçŸ¥è¿™å‡ ç±»æµ‹è¯•æ‰‹æ®µï¼ˆå¦å¤–ä¸€ç§æ˜¯UIè‡ªåŠ¨åŒ–æµ‹è¯•ï¼‰ï¼Œåœ¨å¿…è¦çš„æ—¶å€™æ ¹æ®éœ€æ±‚ï¼Œæ¯”å¦‚å¿…ä¸å¯å…çš„å¤æ‚é€»è¾‘å¤„ï¼Œä½¿ç”¨ç›¸åº”çš„æµ‹è¯•ï¼Œä¸€å®šç¨‹åº¦ä¸Šä¿è¯å®¢æˆ·ç«¯çš„ç¨³å®šæ€§ã€‚

åæœŸå¾…è¡¥å……çš„ç›¸å…³çŸ¥è¯†ï¼š

1. Mockitoçš„ä½¿ç”¨ï¼›
2. Android Testing Support Libraryæä¾›çš„ä¸€äº›æ–°åŠŸèƒ½ï¼›
3. Androidä¸Šå¯¹Activityã€Serviceã€ContentProviderã€Applicationç­‰ç»„ä»¶çš„æµ‹è¯•æ”¯æŒï¼›
4. UIè‡ªåŠ¨åŒ–æµ‹è¯•æ¡†æ¶ï¼›